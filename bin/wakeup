#!/usr/bin/env node

var IRKit = require('irkit');
var Netatmo = require('netatmo');

var IRKIT_CLIENT_KEY = process.env.IRKIT_CLIENT_KEY;
var IRKIT_DEVICE_ID = process.env.IRKIT_DEVICE_ID;

var NETATMO_CLIENT_ID = process.env.NETATMO_CLIENT_ID;
var NETATMO_CLIENT_SECRET = process.env.NETATMO_CLIENT_SECRET;
var NETATMO_USERNAME = process.env.NETATMO_USERNAME;
var NETATMO_PASSWORD = process.env.NETATMO_PASSWORD;

var COOLER_THRESHOLD = process.env.COOLER_THRESHOLD;
var HEATER_THRESHOLD = process.env.HEATER_THRESHOLD;

var COOLER_IR_DATA = [58076,65535,0,32360,6648,3228,873,2451,873,787,873,787,873,787,873,787,873,787,873,787,873,787,873,787,873,787,873,787,873,787,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,787,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,2451,873,2451,873,761,873,761,873,761,873,2451,873,761,873,761,873,2451,873,761,904,761,904,2451,904,2451,904,761,873,2451,873,2451,873,761,873,2451,904,2451,904,761,904,2368,873,2368,873,761,873,761,873,2451,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,761,873,2451,873,2451,873,2451,873,761,873,761,873,761,873,2451,873,761,873,2451,873,2451,873,761,873,2368,904,2368,904,2368,904,761,873,2451,873,761,873,761,873,2451,873,761,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,761,935,761,935,2451,873,761,904,2451,873,761,935,761,935,761,935,2451,873,2451,873,761,873,2451,873,761,935,2368,873,2368,873,761,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,761,904,2451,873,2451,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,2451,873,2451,873,761,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,761,873,2451,873,761,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,761,873,2451,873,2451,873,2451,873,787,873,787,873,787,873,787,873,787,873,787,873,787,873,787,873,787,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,904,761,904,761,904,761,904,761,904,761,904,761,904,761,904,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,2368,904,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873];
var HEATER_IR_DATA = [58076,65535,0,32360,6648,3228,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,787,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,787,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,2451,873,2451,873,761,873,761,873,761,873,2451,873,761,873,761,873,2451,873,761,873,761,873,2451,873,2451,873,761,873,2451,873,2451,873,761,873,2451,873,2451,873,787,873,2451,873,2451,873,761,873,761,873,2451,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,787,873,2451,873,2451,873,2451,873,761,873,761,873,2451,873,2451,873,2451,873,761,873,2451,873,787,873,2451,873,2451,873,761,873,761,873,761,873,2451,873,761,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,761,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,761,873,761,761,761,873,761,873,761,873,761,873,761,873,761,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,2368,873,761,873,761,873,761,761,761,873,761,873,761,873,761,873,761,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,761,873,761,761,761,873,761,873,761,873,761,873,761,761,761,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,2451,873,873,873,2451,873,2451,873,761,873,2451,873,761,761,2451,873,787,873,2451,873,761,873,761,761,2451,873,761,873,2451,873,761,873,2451,873,2451,873,761,873,761,873,761,873,2451,815,2451,815,2451,815,2451,815,815,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,2451,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,815,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,2451,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815,815];
var api = new Netatmo({
    'client_id'     : NETATMO_CLIENT_ID,
    'client_secret' : NETATMO_CLIENT_SECRET,
    'username'      : NETATMO_USERNAME,
    'password'      : NETATMO_PASSWORD,
});

var sendIRSignal = function(ir_data) {
	irkit = new IRKit({
		clientKey: IRKIT_CLIENT_KEY,
		deviceId: IRKIT_DEVICE_ID,
	});
	signal = {
		format: 'raw',
		freq: 38,
		data: ir_data,
	};
	irkit.send(signal)
  		.then(function() { 
			console.log('Send!'); 
			process.exit(0);
		})
  		.catch(function(errMsg) { 
			console.error(errMsg); 
			process.exit(1);
		});
}

api.getStationsData(function(err, devices) {
    currentTemp = devices[0].dashboard_data.Temperature;
    console.log(currentTemp);
    if (currentTemp > COOLER_THRESHOLD) {
    	console.log('hot');
	sendIRSignal(COOLER_IR_DATA);
    } else if (currentTemp < HEATER_THRESHOLD) {
    	console.log('cold');
	sendIRSignal(HEATER_IR_DATA);
    } else {
        console.log('Not too hot');
	process.exit(0);
    }
});
